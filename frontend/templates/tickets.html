{% extends "base.html" %}

{% block title %}Tickets - HelpDesk Mini{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-white">ðŸŽ« Tickets</h2>
    <button class="btn btn-secondary" onclick="logout()">Logout</button>
  </div>

  <!-- Search Tickets -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search tickets..." oninput="loadTickets(0)">
  </div>

  <!-- Create Ticket Form -->
  <div class="card p-4 mb-4 bg-dark bg-opacity-75 text-white shadow rounded-4">
    <h5>Create New Ticket</h5>
    <form id="ticketForm">
      <input class="form-control mb-2" type="text" id="title" placeholder="Title" required>
      <textarea class="form-control mb-2" id="description" placeholder="Description" required></textarea>
      <select class="form-control mb-2" id="priority" required>
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
      </select>
      <button class="btn btn-success w-100">Create Ticket</button>
    </form>
  </div>

  <!-- Tickets List -->
  <div id="tickets"></div>
</div>

<style>
.badge-open { background-color: #63856b; }        
.badge-in_progress { background-color: #83a1ce; } 
.badge-closed { background-color: #dc3545; }      
.ticket-breached { border-left: 4px solid #dc3545 !important; }
.sla-timer { font-weight: bold; }
.comment-reply { margin-left: 20px; border-left: 2px dashed #555; padding-left: 8px; margin-top: 4px; }
</style>

<script>
const accessToken = localStorage.getItem('access_token');
if (!accessToken) {
  alert('You are not logged in! Redirecting...');
  window.location.href = '/login/';
}

let currentOffset = 0;
const limit = 5;
let agents = [];

// Logout
function logout() {
  localStorage.removeItem('access_token');
  localStorage.removeItem('refresh_token');
  window.location.href = '/';
}

// Fetch agents for admin assign dropdown
async function fetchAgents() {
  try {
    const res = await fetch('/api/users/?role=agent', {
      headers: { 'Authorization': `Bearer ${accessToken}` }
    });
    if (!res.ok) throw new Error('Failed to load agents');
    agents = await res.json();
  } catch (err) {
    console.error(err);
  }
}

// Format SLA
function formatSLA(slaRemaining) {
  if (slaRemaining === 'Breached') return 'âš  SLA Breached!';
  return slaRemaining;
}

// Load Tickets with Pagination
async function loadTickets(offset = 0) {
  try {
    const search = document.getElementById('searchInput').value;
    const url = `/api/tickets/?limit=${limit}&offset=${offset}&search=${encodeURIComponent(search)}`;
    const res = await fetch(url, {
      headers: { 'Authorization': `Bearer ${accessToken}` }
    });
    if (!res.ok) throw new Error('Failed to load tickets');
    const data = await res.json();
    const container = document.getElementById('tickets');
    container.innerHTML = "";

    data.results.forEach(t => {
      const slaClass = t.sla_remaining === 'Breached' && t.status !== 'closed' ? 'ticket-breached' : '';
      let assignHTML = '';
      if (t.user_role === 'admin') {
        assignHTML = `
          <div class="mt-2">
            <label class="form-label">Assign to Agent:</label>
            <select class="form-select mb-2" onchange="assignAgent(${t.id}, this.value)">
              <option value="">Select Agent</option>
              ${agents.map(a => `<option value="${a.id}" ${t.assignee === a.username ? 'selected' : ''}>${a.username}</option>`).join('')}
            </select>
          </div>`;
      }
      container.innerHTML += `
        <div class="card mb-3 p-3 bg-dark bg-opacity-75 text-white shadow rounded-4 ${slaClass}">
          <h5>${t.title} 
            <span class="badge badge-${t.status} text-white">${t.status.replace('_',' ')}</span>
          </h5>
          <p>${t.description}</p>
          <small>Priority: ${t.priority} | SLA: <span class="sla-timer">${formatSLA(t.sla_remaining)}</span></small>
          <br><br>
          <button class="btn btn-sm btn-primary me-2" onclick="updateStatus(${t.id})">Mark In Progress</button>
          <button class="btn btn-sm btn-secondary me-2" onclick="addComment(${t.id})">Add Comment</button>
          <button class="btn btn-sm btn-info" onclick="loadTimeline(${t.id}, t.timeline_logs)">View Timeline</button>
          <div id="comments-${t.id}" class="mt-2"></div>
          <div id="timeline-${t.id}" class="mt-2"></div>
          ${assignHTML}
        </div>
      `;
      loadComments(t.id, t.comments);
    });

    // Pagination controls
    container.innerHTML += `
      <div class="d-flex justify-content-between mt-3">
        <button class="btn btn-sm btn-outline-light" ${offset <= 0 ? 'disabled' : ''} onclick="prevPage()">Prev</button>
        <button class="btn btn-sm btn-outline-light" ${!data.next ? 'disabled' : ''} onclick="nextPage()">Next</button>
      </div>
    `;
    currentOffset = offset;

  } catch (err) {
    console.error(err);
    alert('Error loading tickets. Please login again.');
    window.location.href = '/login/';
  }
}

function nextPage() { loadTickets(currentOffset + limit); }
function prevPage() { loadTickets(Math.max(currentOffset - limit, 0)); }

// Render Comments recursively
function renderComments(comments) {
  return comments.map(c => {
    let repliesHTML = '';
    if (c.replies && c.replies.length) {
      repliesHTML = renderComments(c.replies).map(r => `<div class="comment-reply">${r}</div>`).join('');
    }
    return `<div><small><b>${c.user}</b>: ${c.text}</small>${repliesHTML}</div>`;
  }).join('');
}

function loadComments(ticketId, commentsData) {
  const container = document.getElementById(`comments-${ticketId}`);
  container.innerHTML = renderComments(commentsData || []);
}

function loadTimeline(ticketId, logsData) {
  const container = document.getElementById(`timeline-${ticketId}`);
  container.innerHTML = logsData.map(l => `<small>${l.action_type} by ${l.metadata?.user || 'unknown'} at ${new Date(l.created_at).toLocaleString()}</small><br>`).join('');
}

// Create Ticket
document.getElementById('ticketForm').addEventListener('submit', async e => {
  e.preventDefault();
  const title = document.getElementById('title').value;
  const description = document.getElementById('description').value;
  const priority = document.getElementById('priority').value;

  try {
    const res = await fetch('/api/tickets/', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, description, priority })
    });
    if (!res.ok) throw new Error('Failed to create ticket');
    document.getElementById('ticketForm').reset();
    loadTickets(currentOffset);
  } catch (err) { alert(err.message); }
});

// Update Status
async function updateStatus(ticketId) {
  try {
    const res = await fetch(`/api/tickets/${ticketId}/`, {
      method: 'PATCH',
      headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'in_progress' })
    });
    if (!res.ok) throw new Error('Failed to update status');
    loadTickets(currentOffset);
  } catch (err) { alert(err.message); }
}

// Add Comment
async function addComment(ticketId) {
  const text = prompt('Enter your comment:');
  if (!text) return;
  try {
    const res = await fetch(`/api/tickets/${ticketId}/add_comment/`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    if (!res.ok) throw new Error('Failed to add comment');
    loadTickets(currentOffset);
  } catch (err) { alert(err.message); }
}

// Assign Agent
async function assignAgent(ticketId, agentId) {
  if (!agentId) return;
  try {
    const res = await fetch(`/api/tickets/${ticketId}/assign_agent/`, {
      method: 'PATCH',
      headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ agent_id: agentId })
    });
    if (!res.ok) throw new Error('Failed to assign agent');
    loadTickets(currentOffset);
  } catch (err) { alert(err.message); }
}

// Real-time SLA update every minute
setInterval(() => { loadTickets(currentOffset); }, 60000);

window.onload = async () => { await fetchAgents(); loadTickets(0); };
</script>
{% endblock %}